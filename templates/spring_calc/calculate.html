{% extends 'base.html' %}
{% load static %}

{% block title %}Suspension Calculator - GT7 Tuning{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/calculator.css' %}">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">GT7 Suspension Calculator</h3>
                <div>
                    <a href="{% url 'upload_screenshot' %}" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-camera"></i> Upload Screenshots
                    </a>
                    <form action="/spring-calculator/reset-all-data/" method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="redirect_url" value="{{ request.path }}">
                            <button type="submit" class="btn btn-danger">Reset All Data</button>
                        </form>
                </div>
            </div>
            <div class="card-body">
                {% if calculation %}
                    <div class="alert alert-success">
                        <h4 class="alert-heading">Calculation Complete!</h4>
                        <p>Your optimal suspension settings have been calculated based on the provided values.</p>
                        <a href="{% url 'calculate_gears' %}" class="btn btn-primary">Continue to Gear Calculator</a>
                        <a href="{% url 'complete_setup' %}" class="btn btn-outline-light ms-2">View Complete Setup</a>
                    </div>
                {% endif %}
                
                <form method="post" id="springCalcForm">
                    {% csrf_token %}
                    
                    <!-- Form Sections -->
                    <div class="row">
                        <!-- Vehicle Information Section -->
                        <div class="col-md-6">
                            <div class="form-section">
                                <h4 class="section-title">Vehicle Information</h4>
                                
                                <div class="mb-3">
                                    <label for="{{ form.vehicle.id_for_label }}" class="form-label">Vehicle</label>
                                    {{ form.vehicle }}
                                    <div class="form-text">{{ form.vehicle.help_text }}</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.vehicle_weight.id_for_label }}" class="form-label">Vehicle Weight (kg)</label>
                                            {{ form.vehicle_weight }}
                                            <div class="form-text">{{ form.vehicle_weight.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.front_weight_distribution.id_for_label }}" class="form-label">Front Weight Distribution (%)</label>
                                            {{ form.front_weight_distribution }}
                                            <div class="form-text">{{ form.front_weight_distribution.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.front_tires.id_for_label }}" class="form-label">Front Tires</label>
                                            {{ form.front_tires }}
                                            <div class="form-text">{{ form.front_tires.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.rear_tires.id_for_label }}" class="form-label">Rear Tires</label>
                                            {{ form.rear_tires }}
                                            <div class="form-text">{{ form.rear_tires.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.front_ride_height.id_for_label }}" class="form-label">Front Ride Height (mm)</label>
                                            {{ form.front_ride_height }}
                                            <div class="form-text">{{ form.front_ride_height.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.rear_ride_height.id_for_label }}" class="form-label">Rear Ride Height (mm)</label>
                                            {{ form.rear_ride_height }}
                                            <div class="form-text">{{ form.rear_ride_height.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.front_downforce.id_for_label }}" class="form-label">Front Downforce</label>
                                            {{ form.front_downforce }}
                                            <div class="form-text">{{ form.front_downforce.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.rear_downforce.id_for_label }}" class="form-label">Rear Downforce</label>
                                            {{ form.rear_downforce }}
                                            <div class="form-text">{{ form.rear_downforce.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Handling Adjustments Section -->
                        <div class="col-md-6">
                            <div class="form-section">
                                <h4 class="section-title">Handling Adjustments</h4>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.stiffness_multiplier.id_for_label }}" class="form-label">Stiffness Multiplier</label>
                                            {{ form.stiffness_multiplier }}
                                            <div class="form-text">{{ form.stiffness_multiplier.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.arb_stiffness_multiplier.id_for_label }}" class="form-label">ARB Stiffness</label>
                                            {{ form.arb_stiffness_multiplier }}
                                            <div class="form-text">{{ form.arb_stiffness_multiplier.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.spring_frequency_offset.id_for_label }}" class="form-label">Spring Frequency Offset</label>
                                            {{ form.spring_frequency_offset }}
                                            <div class="form-text">{{ form.spring_frequency_offset.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.ou_adjustment.id_for_label }}" class="form-label">Oversteer/Understeer</label>
                                            {{ form.ou_adjustment }}
                                            <div class="form-text">{{ form.ou_adjustment.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.corner_entry_adjustment.id_for_label }}" class="form-label">Corner Entry Adjustment</label>
                                            {{ form.corner_entry_adjustment }}
                                            <div class="form-text">{{ form.corner_entry_adjustment.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.corner_exit_adjustment.id_for_label }}" class="form-label">Corner Exit Adjustment</label>
                                            {{ form.corner_exit_adjustment }}
                                            <div class="form-text">{{ form.corner_exit_adjustment.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.track_type.id_for_label }}" class="form-label">Track Type</label>
                                            {{ form.track_type }}
                                            <div class="form-text">{{ form.track_type.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.tire_wear_multiplier.id_for_label }}" class="form-label">Tire Wear Multiplier</label>
                                            {{ form.tire_wear_multiplier }}
                                            <div class="form-text">{{ form.tire_wear_multiplier.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- G-Force Values Section -->
                    <div class="form-section mt-4">
                        <h4 class="section-title">Stability & G-Force Values</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.low_speed_stability.id_for_label }}" class="form-label">Low Speed Stability</label>
                                    {{ form.low_speed_stability }}
                                    <div class="form-text">{{ form.low_speed_stability.help_text }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.high_speed_stability.id_for_label }}" class="form-label">High Speed Stability</label>
                                    {{ form.high_speed_stability }}
                                    <div class="form-text">{{ form.high_speed_stability.help_text }}</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="{{ form.rotational_g_40mph.id_for_label }}" class="form-label">G-Force @ 40 mph</label>
                                    {{ form.rotational_g_40mph }}
                                    <div class="form-text">{{ form.rotational_g_40mph.help_text }}</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="{{ form.rotational_g_75mph.id_for_label }}" class="form-label">G-Force @ 75 mph</label>
                                    {{ form.rotational_g_75mph }}
                                    <div class="form-text">{{ form.rotational_g_75mph.help_text }}</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="{{ form.rotational_g_150mph.id_for_label }}" class="form-label">G-Force @ 150 mph</label>
                                    {{ form.rotational_g_150mph }}
                                    <div class="form-text">{{ form.rotational_g_150mph.help_text }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions mt-4 text-center">
                        <button type="submit" class="btn btn-primary btn-lg">Calculate Suspension Settings</button>
                        <button type="reset" class="btn btn-outline-secondary btn-lg ms-2" onclick="return confirm('Are you sure you want to reset this form?');">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if calculation %}
<!-- Results Display -->
<div class="row">
    <div class="col-md-12">
        <div class="card bg-dark border-success">
            <div class="card-header">
                <h3 class="mb-0">Calculated Suspension Settings</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Spring Rates -->
                    <div class="col-md-4">
                        <div class="results-section">
                            <h4 class="results-title">Spring Rates</h4>
                            
                            <div class="result-item">
                                <div class="result-label">Front Spring Frequency:</div>
                                <div class="result-value">{{ calculation.front_spring_frequency }} Hz</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Rear Spring Frequency:</div>
                                <div class="result-value">{{ calculation.rear_spring_frequency }} Hz</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dampers -->
                    <div class="col-md-4">
                        <div class="results-section">
                            <h4 class="results-title">Dampers</h4>
                            <div class="result-item">
                                <div class="result-label">Front Compression:</div>
                                <div class="result-value">{{ front_compression }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Front Extension:</div>
                                <div class="result-value">{{ front_extension }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Rear Compression:</div>
                                <div class="result-value">{{ rear_compression }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Rear Extension:</div>
                                <div class="result-value">{{ rear_extension }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Geometry -->
                    <div class="col-md-4">
                        <div class="results-section">
                            <h4 class="results-title">Geometry</h4>
                            <div class="result-item">
                                <div class="result-label">Front Roll Bar:</div>
                                <div class="result-value">{{ calculation.front_roll_bar|floatformat:"0" }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Rear Roll Bar:</div>
                                <div class="result-value">{{ calculation.rear_roll_bar|floatformat:"0" }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Front Camber:</div>
                                <div class="result-value">{{ calculation.front_camber }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Rear Camber:</div>
                                <div class="result-value">{{ calculation.rear_camber }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Front Toe:</div>
                                <div class="result-value">{{ calculation.front_toe }}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Rear Toe:</div>
                                <div class="result-value">{{ calculation.rear_toe }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="actions mt-4 text-center">
                    <a href="{% url 'calculate_gears' %}" class="btn btn-primary">Continue to Gear Calculator</a>
                    <a href="{% url 'complete_setup' %}" class="btn btn-success ms-2">View Complete Setup</a>
                    <button id="saveSetupBtn" class="btn btn-outline-light ms-2" data-bs-toggle="modal" data-bs-target="#saveSetupModal">
                        <i class="bi bi-save"></i> Save Setup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Setup Modal -->
<div class="modal fade" id="saveSetupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Save Setup</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="setupName" class="form-label">Setup Name</label>
                    <input type="text" class="form-control" id="setupName" placeholder="My Awesome Setup">
                </div>
                <div class="mb-3">
                    <label for="setupNotes" class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="setupNotes" rows="3" placeholder="Any notes about this setup..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">Save Setup</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/spring_calculator.js' %}"></script>
{% endblock %}