{% extends 'base.html' %}
{% load static %}

{% block title %}Gear Calculator - GT7 Tuning{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/calculator.css' %}">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">GT7 Gear Ratio Calculator</h3>
                <div>
                    <a href="{% url 'upload_screenshot' %}" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-camera"></i> Upload Screenshots
                    </a>
                    <form action="/spring-calculator/reset-all-data/" method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="redirect_url" value="{{ request.path }}">
                            <button type="submit" class="btn btn-danger">Reset All Data</button>
                        </form>
                </div>
            </div>
            <div class="card-body">
                {% if calculation %}
                    <div class="alert alert-success">
                        <h4 class="alert-heading">Calculation Complete!</h4>
                        <p>Your optimal gear ratios have been calculated based on the provided values.</p>
                        <a href="{% url 'complete_setup' %}" class="btn btn-outline-light">View Complete Setup</a>
                    </div>
                {% endif %}
                
                {% if vehicle_name %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Currently working with: <strong>{{ vehicle_name }}</strong>
                    </div>
                {% endif %}
                
                <form method="post" id="gearCalcForm">
                    {% csrf_token %}
                    
                    <!-- Form Sections -->
                    <div class="row">
                        <!-- Vehicle & Track Information Section -->
                        <div class="col-md-6">
                            <div class="form-section">
                                <h4 class="section-title">Vehicle & Track Information</h4>
                                
                                <div class="mb-3">
                                    <label for="{{ form.vehicle.id_for_label }}" class="form-label">Vehicle</label>
                                    {{ form.vehicle }}
                                    <div class="form-text">{{ form.vehicle.help_text }}</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.top_speed_mph.id_for_label }}" class="form-label">Top Speed (mph)</label>
                                            {{ form.top_speed_mph }}
                                            <div class="form-text">{{ form.top_speed_mph.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.min_corner_speed_mph.id_for_label }}" class="form-label">Min Corner Speed (mph)</label>
                                            {{ form.min_corner_speed_mph }}
                                            <div class="form-text">{{ form.min_corner_speed_mph.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.min_corner_gear.id_for_label }}" class="form-label">Minimum Corner Gear</label>
                                            {{ form.min_corner_gear }}
                                            <div class="form-text">{{ form.min_corner_gear.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.num_gears.id_for_label }}" class="form-label">Number of Gears</label>
                                            {{ form.num_gears }}
                                            <div class="form-text">{{ form.num_gears.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="{{ form.tire_diameter_inches.id_for_label }}" class="form-label">Tire Diameter (inches)</label>
                                            {{ form.tire_diameter_inches }}
                                            <div class="form-text">{{ form.tire_diameter_inches.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#tireSizeModal">
                                                Calculate Tire Size
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Engine Specifications Section -->
                        <div class="col-md-6">
                            <div class="form-section">
                                <h4 class="section-title">Engine Specifications</h4>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.power_hp.id_for_label }}" class="form-label">Power (HP)</label>
                                            {{ form.power_hp }}
                                            <div class="form-text">{{ form.power_hp.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.torque_kgfm.id_for_label }}" class="form-label">Torque (kg-fm)</label>
                                            {{ form.torque_kgfm }}
                                            <div class="form-text">{{ form.torque_kgfm.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="{{ form.min_rpm.id_for_label }}" class="form-label">Min RPM</label>
                                            {{ form.min_rpm }}
                                            <div class="form-text">{{ form.min_rpm.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="{{ form.max_rpm.id_for_label }}" class="form-label">Max RPM</label>
                                            {{ form.max_rpm }}
                                            <div class="form-text">{{ form.max_rpm.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="{{ form.max_power_rpm.id_for_label }}" class="form-label">Max Power RPM</label>
                                            {{ form.max_power_rpm }}
                                            <div class="form-text">{{ form.max_power_rpm.help_text }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions mt-4 text-center">
                        <button type="submit" class="btn btn-primary btn-lg">Calculate Gear Ratios</button>
                        <button type="reset" class="btn btn-outline-secondary btn-lg ms-2" onclick="return confirm('Are you sure you want to reset this form?');">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tire Size Calculator Modal -->
<div class="modal fade" id="tireSizeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Calculate Tire Size</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter the following values to calculate your tire diameter:</p>
                
                <div class="mb-3">
                    <label for="speedInput" class="form-label">Speed (km/h)</label>
                    <input type="number" class="form-control" id="speedInput" placeholder="120" min="1" max="500" step="0.1">
                    <div class="form-text">Current speed in km/h</div>
                </div>
                
                <div class="mb-3">
                    <label for="rpmInput" class="form-label">Engine RPM</label>
                    <input type="number" class="form-control" id="rpmInput" placeholder="5000" min="1000" max="12000">
                    <div class="form-text">Current engine RPM</div>
                </div>
                
                <div class="mb-3">
                    <label for="gearRatioInput" class="form-label">Gear Ratio</label>
                    <input type="number" class="form-control" id="gearRatioInput" placeholder="1.050" min="0.1" max="5" step="0.001">
                    <div class="form-text">Current gear ratio</div>
                </div>
                
                <div class="mb-3">
                    <label for="finalDriveInput" class="form-label">Final Drive</label>
                    <input type="number" class="form-control" id="finalDriveInput" placeholder="3.700" min="2" max="6" step="0.001">
                    <div class="form-text">Final drive ratio</div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <div id="tireSizeResult" class="me-auto"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="calculateTireSizeBtn">Calculate</button>
                <button type="button" class="btn btn-success d-none" id="applyTireSizeBtn">Apply to Form</button>
            </div>
        </div>
    </div>
</div>

{% if calculation %}
<!-- Results Display -->
<div class="row">
    <div class="col-md-12">
        <div class="card bg-dark border-success">
            <div class="card-header">
                <h3 class="mb-0">Calculated Gear Ratios</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Gear Ratios -->
                    <div class="col-md-4">
                        <div class="results-section">
                            <h4 class="results-title">Gear Ratios</h4>
                            
                            {% for gear_name, gear_ratio in calculation.gear_ratios.items %}
                            <div class="result-item">
                                <div class="result-label">{{ gear_name }}:</div>
                                <div class="result-value">{{ gear_ratio }}</div>
                            </div>
                            {% endfor %}
                            
                            <div class="result-item">
                                <div class="result-label">Final Drive:</div>
                                <div class="result-value">{{ calculation.final_drive }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Speed Information -->
                    <div class="col-md-4">
                        <div class="results-section">
                            <h4 class="results-title">Speed Information</h4>
                            
                            
                            {% if gear_speeds %}
                                <h5 class="mt-3 mb-2">Gear Speeds at Max Power</h5>
                                {% for gear_name, speed in gear_speeds.items %}
                                <div class="result-item">
                                    <div class="result-label">{{ gear_name }}:</div>
                                    <div class="result-value">{{ speed }} mph</div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Power Curve Graph -->
                    <div class="col-md-4">
                        <div class="results-section">
                            <h4 class="results-title">Power & Torque Curve</h4>
                            <div id="powerCurveGraph" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Gear Graph Section -->
                <div id="gearGraph" style="height: 300px; width: 100%; background-color: #000; border-radius: 4px; position: relative;">
                    <div id="graphFallback" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555; text-align: center;">
                        <p>Gear graph loading...</p>
                    </div>
                </div>
                
                <div class="actions mt-4 text-center">
                    <a href="{% url 'complete_setup' %}" class="btn btn-success">View Complete Setup</a>
                    <button id="saveSetupBtn" class="btn btn-outline-light ms-2" data-bs-toggle="modal" data-bs-target="#saveSetupModal">
                        <i class="bi bi-save"></i> Save Setup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Setup Modal -->
<div class="modal fade" id="saveSetupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Save Setup</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="setupName" class="form-label">Setup Name</label>
                    <input type="text" class="form-control" id="setupName" placeholder="My Racing Setup">
                </div>
                <div class="mb-3">
                    <label for="setupNotes" class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="setupNotes" rows="3" placeholder="Any notes about this setup..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">Save Setup</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/gear_calculator.js' %}"></script>
{% endblock %}